<div class="section-1">
    <div class="popUp hide">
        
        <div id="pop" class="popUp-container flex-column" style="min-height: 100px;max-height:100vh;margin-left:10px">

        </div>
    </div>

    <%- include ('totembar.ejs') %>
    <div class="workspace">
        <h2>Daftar Peserta</h2>
        <hr>
        <div class="myaccordion flex-column width-full">
            <h5 class="myaccordion-header"><i class="fa-solid fa-circle-chevron-down"></i> A. Daftar secara pukal</h5>
            <div class="myaccordion-body hide">
                <div class="flex-row">
                    Sila muat turun &nbsp;
                    <a class="capsule " href="./templates/_templat_pendaftaran_techlympic.xlsx">
                        <i class="fa-solid fa-file-excel text-green"></i>&nbsp;&nbsp;
                        templat pendaftaran
                    </a>&nbsp;
                    untuk mendaftarkan penyertaan secara pukal
                </div>
                <div>Fail yang telah dilengkapkan boleh di muat naik pada panel di bawah</div>
                <div id="input-tray" class="input-tray fill-container flex-column center">
                    <span>Muat naik borang anda di sini</span>
                    <input type="file" class="custom-file-input" id="file-input" onchange="readFile()">
                </div>
            </div>

        </div>

        <hr>
        <div class="myaccordion flex-column width-full">
            <h5 class="myaccordion-header"><i class="fa-solid fa-circle-chevron-down"></i> B. Daftar secara individu</h5>
            <div class="myaccordion-body hide">
                <div class="flex-row my-6">
                    <div class="col-label">Nama</div>
                    <div>
                        <input type="text" name="txtnama" id="txtnama">
                    </div>
                </div>
                <div class="flex-row my-6">
                    <div class="col-label">Kad Pengenalan (KP)</div>
                    <div>
                        <input type="text" name="txtkp" id="txtkp">
                    </div>
                </div>
                <div class="flex-row my-6">
                    <div class="col-label">Jantina</div>
                    <div>
                        <select name="seljantina" id="seljantina">
                            <option value=""></option>
                            <option value="Lelaki">Lelaki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                </div>
                <div class="flex-row my-6">
                    <div class="col-label">Tarikh Lahir</div>
                    <div>
                        <input type="date" name="txtkp" id="txtdob">
                    </div>
                </div>
                <div class="flex-row my-6">
                    <div class="col-label">Email</div>
                    <div>
                        <input type="text" name="txtemail" id="txtemail">
                    </div>
                </div>
                <div class="flex-row my-6">
                    <div class="col-label">Darjah/ Tingkatan</div>
                    <div>
                        <input type="text" name="txtdarjah" id="txtdarjah">
                    </div>
                </div>
                <div class="flex-row my-6">
                    <div class="col-label">Penyertaan</div>
                    <div id="individu_acara" class="flex-column">
                        
                    </div>
                </div>
                <div class="flex-row my-6">
                    <button class="button float-right" id="saveIndividu"><i class="fa-solid fa-floppy-disk"></i>&nbsp;&nbsp;Simpan</button>
                </div>
            </div>
        </div>

    </div>
    
    <div class="idlePopUp hide">
        <i class="fa-solid fa-spinner fa-spin-pulse"></i>
    </div>
    
    <div id="popUp-list" class="popUp hide">
        <div class="popUp-container flex-column width-full" id="listContainer">
            <div class="acara-list">
                <div class="flex-row">
                    <h5>Sila pilih pertandingan</h5>
                    <div class="button float-right" onclick="closePopup()"><i class="fa-solid fa-x"></i></div>
                </div>
                <div class="flex-row acara" style="font-style:italic;color:var(--secondary-color) !important;padding-bottom:20px;border-bottom: 1px solid rgb(102, 102, 102);">
                    <input type="checkbox" class="chk_select_all" id="chk_select_all" name="chk_select_all" value="Pilih Semua">
                    <label for="chk_select_all" style="padding-left: 6px;">Pilih Semua Pertandingan</label>
                </div>
                <div class="pertandingan"></div>
                
                <div class="flex-row py-6">
                    <div class="button" id="btn-selectCommon"><i class="fa-solid fa-square-check"></i>&nbsp;&nbsp;Pilih</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get file input element
        const fileInput = document.getElementById('file-input');
        
        // Add event listeners for drag and drop
        fileInput.addEventListener('dragenter', function(event) {
            event.preventDefault();
            event.stopPropagation();
            fileInput.classList.add('dragover');
        });
        
        fileInput.addEventListener('dragleave', function(event) {
            event.preventDefault();
            event.stopPropagation();
            fileInput.classList.remove('dragover');
        });
        
        fileInput.addEventListener('dragover', function(event) {
            event.preventDefault();
            event.stopPropagation();
        });
        
        fileInput.addEventListener('drop', function(event) {
            event.preventDefault();
            event.stopPropagation();
            fileInput.classList.remove('dragover');
            fileInput.files = event.dataTransfer.files;

            readFile();
        });

    </script>
    <!--
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
     Include the SheetJS library 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    -->
    <script src="./assets/jquery/3.6.0/jquery-3.6.0.min.js"></script>
    <script src="./assets/d3/v7/d3.v7.min.js"></script>
    <script src="./assets/xlsx/xlsx.full.min.js"></script>

    <script>
        var API = {
            addbulk: (data, fn) => {
                d3.select('.popUp').classed('hide',false);
                d3.select('.popUp-container').append('div').text('menyimpan data...')
                $.ajax({
                        type: "POST",
                        url: '/api/peserta/add',
                        data: {peserta:data},
                        success: function (res) {
                            d3.select('.popUp').classed('hide',true);
                            d3.select('.popUp-container').selectAll('*').remove()
                            fn(res);
                        },
                        dataType: 'json'
                    });
            },
            loadPrograms(fn){
                $.ajax({
                        type: "POST",
                        url: '/api/program/list',
                        data: {},
                        success: function (res) {
                            
                            fn(res);
                        },
                        dataType: 'json'
                    });
            }
        }


        API.loadPrograms((prog)=>{
            console.log(prog);
            lst = [];
            prog.forEach((d)=>{
                lst.push({id:'__tmp__', acara:d.prog_name});
            });
            acara = d3.select('#individu_acara');
            acara_contain = acara.append('div').attr('class','flex-column');
            acara_contain.selectAll('.acara').data(lst).enter().append('div').call((a)=>{
                a.attr('class','flex-row acara').attr('id',(d)=>'acara_' + d.id).style('border-bottom','1px solid #666');
                chk = a.append('input').attr('type','checkbox').attr('class',(d)=>('_header'))
                .attr('id',(d, i)=>('_' + d.id + '_' + i))
                .attr('name',(d)=>('_' + d.id))
                .attr('value', d=>d.acara);
                a.append('label').style('padding-left','6px').attr('for',(d, i)=>('_' + d.id + '_' + i)).text(d=>d.acara);

                chk.on('change',(e, d)=>{
                    ic = e.target.id.split('_')[1];
                    nx = d3.selectAll('._' + ic + ':checked').data();
                    n = nx.length;
                    
                    d3.select('#button-' + ic).classed('bg-green',n>0?true:false).html((n>0)?'<i class="fa-solid fa-person-walking-arrow-right"></i>&nbsp;&nbsp;Penyertaan<div class="float-right score">' + n + '</div>':'<i class="fa-solid fa-xmark"></i>&nbsp;&nbsp;Pilih penyertaan...')
                    console.log(e.target.id, d, ic, n);

                })
            });
        });
    </script>

    <script>
    function readFile() {
      // Get the file input element
      var fileInput = document.getElementById('file-input');
    
      // Get the first file from the input element
      var file = fileInput.files[0];
    
      // Create a new FileReader object
      var reader = new FileReader();
    
      // When the FileReader object is done loading the file
      reader.onload = function(event) {
        // Get the binary data from the loaded file
        var data = event.target.result;
    
        // Parse the binary data into a workbook object
        var workbook = XLSX.read(data, { type: 'binary' });
        
    
        // Get the first worksheet from the workbook
        var worksheet = workbook.Sheets[workbook.SheetNames[0]];
    
        // Convert the worksheet data to JSON format
        var jsonData = XLSX.utils.sheet_to_json(worksheet);
    
        // Log the JSON data to the console
        //console.log(jsonData);
        API.loadPrograms((prog)=>{
            lst = [];
            prog.forEach((d)=>{
                lst.push(d.prog_name);
            });
            renderD3Table(lst, jsonData);
        })
        
      };
    
      // Read the file as binary data
      reader.readAsBinaryString(file);
    }

    function getJsonKeys(jsonData) {
    // Create an empty array to store the keys
    var keys = [];

    // Loop through the first object in the JSON data
    for (var key in jsonData[0]) {
        // Add the key to the array
        keys.push(key);
    }

        // Return the array of keys
        return keys;
    }


    function renderD3Table(lst, data){
        //const distinct = arr.filter((value, index, self) => {
        //    return self.indexOf(value) === index;
        //});
        
        
        var setCommonPertandingan = (e)=>{
            var r = d3.selectAll('.chk_acara:checked').data();
            
            d3.selectAll('.chk-all').property('checked',false);
            r.forEach((p)=>{
                d3.selectAll('.chk-all[value="' + p + '"]').property('checked',true);
            });

            data.forEach((d)=>{
                ic = d['no kp'];
                //nx = d3.selectAll('._' + ic + ':checked').data();
                n = r.length;
                d3.select('#button-' + ic).classed('bg-green',n>0?true:false).html((n>0)?'<i class="fa-solid fa-person-walking-arrow-right"></i>&nbsp;&nbsp;Penyertaan<div class="float-right score">' + n + '</div>':'<i class="fa-solid fa-xmark"></i>&nbsp;&nbsp;Pilih penyertaan...')
            });

            $('#popUp-list').addClass('hide');
            
        };
        d3.select('#btn-selectCommon').on('click', setCommonPertandingan);

        kelas = [];
        data.forEach((d)=>{
            d['darjah/ tingkatan'] = d['darjah/ tingkatan'] + '';
            d['no kp'] = d['no kp'] + '';
            
            kelas.push(d['darjah/ tingkatan']);

        });

        kelas = kelas.filter((value, index, self) => {
            return self.indexOf(value) === index;
        });

        kelas.unshift('');
        /*
        lst = [
                'Cabaran Kereta Lestari',
                'Misi Penerbangan Dron',
                'Cabaran Mencipta Robot',
                'Program Jangkauan Techlympics',
                'Cabaran Bandar Pintar',
                'Pemikiran Komputasi Kanak-Kanak'
            ];
            */

        const doFilter = (e, d)=>{
            val = $('#srcfilter').val();

            _d = data.filter((d)=> {
                return (d['nama'].match(val) || d['email'].match(val)) && d['darjah/ tingkatan'].match($('#kelas').val())
            });

            //console.log(_d);

            d3.selectAll('.peserta').classed('hide',true);
            _d.forEach((d)=>{d3.select('.peserta-' + d['no kp']).classed('hide',false)});
        }

        keys = getJsonKeys(data);
        //keys.push('Penyertaan Acara')
        c = d3.select('#input-tray').attr('class','heigth-90vh overflowy-scroll');
        c.selectAll('*').remove();

        table = c.append('table').attr('class','table-x width-full');

        thead = table.append('thead');

        trhs = thead.append('tr');
        ths = trhs.append('th').attr('colspan',7);
        //BUTTON to save
        bts_simpan = ths.append('div').attr('class','flex-row').append('div').attr('class','button float-right').html('<i class="fa-solid fa-floppy-disk"></i>&nbsp;&nbsp;Simpan')
        bts_simpan.on('click', (e)=>{
            //var _data = d3.selectAll(".peserta", {style: "all"}).data();
            var saving_data = [];
            data.forEach((d)=>{
                sel_ = [];
                d3.selectAll('._'+d['no kp'] + ':checked').data().forEach((d)=>{
                    sel_.push(d.acara);
                });

                jantina = $('#gender_' +d['no kp'] ).val();
                dob = $('#dob_' +d['no kp'] ).val();

                sel = sel_.join('|');
                saving_data.push({
                    nama: d.nama,
                    kp: d['no kp'],
                    jantina:jantina,
                    tarikh_lahir:dob,
                    email: d.email,
                    darjah_tingkatan: d['darjah/ tingkatan'],
                    program: sel
                });
                //
            });

            API.addbulk(saving_data, (d)=>{
                console.log(d);
            });
            //console.log(saving_data);
            d3.select('.idlePopUp').classed('hide',false);
                setTimeout(()=>{
                    window.location.replace("./user-peserta-urus");
            }, 8000);
        })

        trh = thead.append('tr');
        trh.selectAll('th').data(keys).enter().append('th').text(d=>d.toUpperCase());
        trh.append('th').text('JANTINA');
        trh.append('th').text('TARIKH LAHIR');
        td_def = trh.append('th').attr('style','width:300px').append('div').attr('class','flex-row center');
        td_def.append('div').text('PENYERTAAN PERTANDINGAN');
        //BUTTON to set default
        btn_def = td_def.append('div').attr('class','button float-right').html('<i class="fa-solid fa-list"></i>');
        btn_def.on('click', ()=>{
            //console.log('lst: ',lst);
            d3.select('#chk_select_all').property('checked',false);
            d3.select('#popUp-list').classed('hide',false);
            acara_contain = d3.select('#listContainer > .acara-list > .pertandingan');

            acara_contain.selectAll('.acara').remove();
            
            acara_contain.selectAll('.acara').data(lst).enter().append('div').call((a)=>{
                a.attr('class','flex-row acara').attr('id',(d)=>'acara_' + d.id).style('border-bottom','1px solid #666');
                chk = a.append('input').attr('type','checkbox').attr('class',(d)=>('chk_acara'))
                .attr('id',(d, i)=>('acara_' + i))
                .attr('name',(d, i)=>('acara_' + i))
                .attr('value', d=>d);
                a.append('label').style('padding-left','6px').attr('for',(d, i)=>('acara_' + i)).text(d=>d);

            });
        })

        trh2 = thead.append('tr');
        src = trh2.append('td').attr('colspan',3).append('input').attr('type','text').style('width','100%').attr('id','srcfilter');

        src2 = trh2.append('td').append('select').attr('id','kelas').style('width','100%');
        src2.selectAll('option').data(kelas.sort((a,b)=>a-b)).enter().append('option').text(d=>d);

        src3 = trh2.append('td').append('select').attr('id','jantina').style('width','100%');
        src3.selectAll('option').data(['','Lelaki','Perempuan']).enter().append('option').text(d=>d);

        trh2.append('td');

        var lst2 = lst.slice();
        lst2.unshift('Belum memilih acara');
        lst2.unshift('Semua Acara');
        src3 = trh2.append('td').append('select').style('width','100%');
        src3.selectAll('option').data(lst2).enter().append('option').text(d=>d);

        src.on('keyup', doFilter);
        src2.on('change', doFilter);

        tbody = table.append('tbody')
        tbody.selectAll('tr').data(data.sort((a,b)=>a['darjah/ tingkatan']-b['darjah/ tingkatan'])).enter().append('tr').call((o)=>{
            o.attr('class',(d)=>'peserta peserta-' + d['no kp']);
            keys.forEach((key, i)=>{
                o.append('td').attr('style',(i===3)?'text-align:center':'text-align:left').text((d)=>d[key]);
            });

            var _jantina = o.append('td').append('select').attr('id',(d)=>'gender_' + d['no kp']).style('width','100%').attr('value',d=>{
                _j = d['no kp'].charAt(d['no kp'].length - 1)*1;
                _v = _j%2==0?'Perempuan':'Lelaki';

                return _v;
            });
            _jantina.selectAll('option').data(d=>{
                _j = d['no kp'].charAt(d['no kp'].length - 1)*1;
                _v = _j%2==0?'Perempuan':'Lelaki';

                return [
                    {chk: _v===''?true:false, val:''},
                    {chk: _v==='Lelaki'?true:false, val:'Lelaki'},
                    {chk: _v==='Perempuan'?true:false, val:'Perempuan'}
                ]
            }).enter().append('option')
                    .attr('value',d=>d.val).text(d=>d.val).property('selected',d=>d.chk);

            var _dob = o.append('td').append('input').attr('id',(d)=>'dob_' + d['no kp']).attr('type','date').style('width','100%').attr('value',(d)=>{
                _t = d['no kp'].substring(0, 2);
                _y = (_t*1)>30?('19' + _t):('20' + _t);
                _m = d['no kp'].substring(2, 4);
                _d = d['no kp'].substring(4, 6); 

                //dd = new Date(_y,_m,_d);
                //console.log(_y,_m,_d,'tarikh......',dd);

                return _y + '-' + _m + '-' + _d
            });

            acara = o.append('td').append('div').attr('class','flex-column');
            acara_header = acara.append('div').attr('class','flex-row');
            btn_acara = acara_header.append('div')
                        .attr('class','button width-full flex-row')
                        .attr('id',(d)=>('button-' + d['no kp']))
                        .html('<i class="fa-solid fa-xmark"></i>&nbsp;&nbsp;Pilih penyertaan...');

            btn_acara.on('click', (e, d) => {
                el = '#container-' + d['no kp'];
                console.log(el, d3.select(el).classed('hide'));

                d3.select(el).classed('hide',!d3.select(el).classed('hide'));
            })

            acara_contain = acara.append('div').attr('class','flex-column hide').attr('id',(d)=>('container-' + d['no kp']));
            acara_contain.selectAll('.acara').data((d)=>{
                console.log(d);
                id = d['no kp'];
                v = [];
                lst.forEach((x)=>v.push({id:id, acara:x}));
                return v;
            }).enter().append('div').call((a)=>{
                a.attr('class','flex-row').attr('id',(d)=>'acara_' + d.id).style('border-bottom','1px solid #666');
                chk = a.append('input').attr('type','checkbox').attr('class',(d)=>('chk-all _' + d.id))
                .attr('id',(d, i)=>('_' + d.id + '_' + i))
                .attr('name',(d)=>('_' + d.id))
                .attr('value', d=>d.acara);
                a.append('label').style('padding-left','6px').attr('for',(d, i)=>('_' + d.id + '_' + i)).text(d=>d.acara);

                chk.on('change',(e, d)=>{
                    ic = e.target.id.split('_')[1];
                    nx = d3.selectAll('._' + ic + ':checked').data();
                    n = nx.length;
                    
                    d3.select('#button-' + ic).classed('bg-green',n>0?true:false).html((n>0)?'<i class="fa-solid fa-person-walking-arrow-right"></i>&nbsp;&nbsp;Penyertaan<div class="float-right score">' + n + '</div>':'<i class="fa-solid fa-xmark"></i>&nbsp;&nbsp;Pilih penyertaan...')
                    console.log(e.target.id, d, ic, n);

                })
            });
        });
    }
    </script>

    <script>
        $('.myaccordion').on('click', (e)=>{
            $('.myaccordion-body').addClass('hide');
            $(e.currentTarget).find('.myaccordion-body').toggleClass('hide');

        });

        $('#txtkp').on('change',(e)=>{
            kp = $('#txtkp').val();
            _j = kp.charAt(kp.length - 1)*1;
            _v = _j%2==0?'Perempuan':'Lelaki';

            $('#seljantina').val(_v);

            _t = kp.substring(0, 2);
            _y = (_t*1)>30?('19' + _t):('20' + _t);
            _m = kp.substring(2, 4);
            _d = kp.substring(4, 6); 

            $('#txtdob').val(_y + '-' + _m + '-' + _d);
        });
    </script>

    <script>
        simpan_ = d3.select('#saveIndividu')
        simpan_.on('click', (e)=>{
            //var _data = d3.selectAll(".peserta", {style: "all"}).data();
            var saving_data = [];
            sel_ = [];
            d3.select('#individu_acara') .selectAll('input[type="checkbox"]:checked').data().forEach((d)=>{
                sel_.push(d.acara);
            });

            jantina = $('#txtjantina' ).val();
            dob = $('#txtdob').val();

            sel = sel_.join('|');
            saving_data.push({
                nama: $('#txtnama').val(),
                kp: $('#txtkp').val(),
                jantina:$('#seljantina').val(),
                tarikh_lahir:$('#txtdob').val(),
                email: $('#txtemail').val(),
                darjah_tingkatan: $('#txtdarjah').val(),
                program: sel
            });

            API.addbulk(saving_data, (d)=>{
                console.log(d);
            });
            //console.log(saving_data);
            d3.select('.idlePopUp').classed('hide',false);
                setTimeout(()=>{
                    window.location.replace("./user-peserta-urus");
            }, 3000);
        });
    </script>

    <script>
        function closePopup(){
            $('#popUp-list').addClass('hide');
        }

        d3.select('#chk_select_all').on('change', (e)=>{
            chk = d3.select('#chk_select_all').property('checked');
            d3.selectAll('.chk_acara').property('checked',chk)
        })
    </script>
</div>
